name: iiplab application deployment

run-name: Run with ${{ github.sha }} commit by ${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      deployUrl:
        description: 'git url'
        required: true
        default: 'https://github.com/gachon-iiplab/docker-images.git'
        type: string
      deployBranch:
        description: 'git branch'
        required: true
        default: 'main'
        type: string
      filename:
        description: '위 깃헙에서 실행시킬 파일의 이름'
        required: false
        default: 'main.py'
        type: string
      dockerTags:
        description: '빌드 / 배포할 환경의 docker tag'
        required: false
        default: 'leesaebom/iiplab:latest'
        type: string
   
          
jobs:
  checkParameters:
    runs-on: ubuntu-latest
    steps:
    - run : echo "deployUrl ${{ github.event.inputs.deployUrl }}"
    - run : echo "deployBranch ${{ github.event.inputs.deployBranch }}"
    - run : echo "onlyDeploy ${{ github.event.inputs.filename }}"
    - run : echo "dockerTags ${{ github.event.inputs.dockerTags }}"
  dockerBuild:
    needs: checkParameters
    runs-on: iiplab
    steps:
    - run: cd ${{ github.workspace }}
    - uses: docker/login-action@v3.1.0
      with:
        # Server address of Docker registry. If not set then will default to Docker Hub
        # Username used to log against the Docker registry
        username: ${{ secrets.DOCKER_USERNAME }}
        # Password or personal access token used to log against the Docker registry
        password: ${{ secrets.DOCKER_PASSWORD }}
    - uses: actions/checkout@v4.1.2
      with:
        repository: ${{ github.event.inputs.deployUrl }}
        ref: ${{ github.event.inputs.deployBranch }}"
    - run: |
           ls -la
           docker build --build-arg GIT_URL=${{ github.event.inputs.deployUrl }} --build-arg FILENAME=${{ github.event.inputs.filename }} -t ${{ github.event.inputs.dockerTags  }} ./base
    - run: docker push ${{ github.event.inputs.dockerTags  }}
  dockerDeploy:
    needs: dockerBuild
    runs-on: iiplab
    steps:
      - uses: docker/login-action@v3.1.0
        with:
          # Server address of Docker registry. If not set then will default to Docker Hub
          # Username used to log against the Docker registry
          username: leesaebom
          # Password or personal access token used to log against the Docker registry
          password: dckr_pat_gA4qT_k77o0rYgBp51MXUWubN8E
      - run: docker pull ${{ github.event.inputs.dockerTags  }}
      - run: docker run --gpus all ${{ github.event.inputs.dockerTags }}
    
              
